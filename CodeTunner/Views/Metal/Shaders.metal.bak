#include <metal_stdlib>
using namespace metal;

// Quad generation via vertexID

struct VertexOut {
    float4 position [[position]];
    float2 texCoord;
};

vertex VertexOut vertex_main(uint vertexID [[vertex_id]]) {
    VertexOut out;
    float2 grid = float2(float(vertexID % 2), float(vertexID / 2));
    out.position = float4(grid * 2.0 - 1.0, 0.0, 1.0);
    out.texCoord = grid;
    return out;
}

// MARK: - Grid Shader
fragment float4 grid_fragment(VertexOut in [[stage_in]],
                             constant float2& resolution [[buffer(0)]],
                             constant float& zoom [[buffer(1)]],
                             constant float2& offset [[buffer(2)]],
                             constant float& gridSize [[buffer(3)]]) {
    
    float2 uv = in.texCoord * resolution;
    uv = (uv - offset) / zoom;
    
    float2 grid = fract(uv / gridSize);
    float dotSize = 2.0 / zoom;
    float dist = length(grid - 0.5) * gridSize;
    
    float alpha = smoothstep(dotSize, dotSize - 1.0/zoom, dist);
    return float4(0.5, 0.5, 0.5, alpha * 0.3);
}

// MARK: - Animated Background Shader
fragment float4 background_fragment(VertexOut in [[stage_in]],
                                   constant float& time [[buffer(0)]],
                                   constant float2& resolution [[buffer(1)]]) {
    float2 uv = in.texCoord;
    float3 color = float3(0.05, 0.05, 0.1); // Deep dark blue
    
    // Subtle glow/pulse
    float pulse = sin(time * 0.5) * 0.5 + 0.5;
    color += float3(0.02, 0.05, 0.1) * pulse * (1.0 - length(uv - 0.5));
    
    // Grid lines
    float2 g = fract(uv * 10.0 + time * 0.1);
    float line = smoothstep(0.02, 0.0, min(g.x, g.y)) + smoothstep(0.98, 1.0, max(g.x, g.y));
    color += float3(0.0, 0.5, 1.0) * line * 0.05;
    
    return float4(color, 1.0);
}
