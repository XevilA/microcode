name: Security - Verify Checksums

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master]

jobs:
  verify-integrity:
    name: üîê Verify Source Integrity
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Make scripts executable
        run: |
          chmod +x generate_checksums.sh verify_checksums.sh 2>/dev/null || true
          
      - name: Verify SHA256 Checksums
        run: |
          echo "üîç Verifying source file integrity..."
          
          if [ -f "CHECKSUMS.sha256" ]; then
            ./verify_checksums.sh
          else
            echo "‚ö†Ô∏è No CHECKSUMS.sha256 found - skipping verification"
            echo "   Run ./generate_checksums.sh locally and commit the file"
          fi
          
      - name: Check for suspicious patterns
        run: |
          echo "üîç Scanning for suspicious patterns..."
          
          # Check for eval/exec in Swift (potential code injection)
          if grep -r "NSAppleScript\|Process(" --include="*.swift" CodeTunner/ 2>/dev/null; then
            echo "‚ö†Ô∏è Warning: Found potential code execution patterns"
          fi
          
          # Check for suspicious URLs in source
          if grep -rE "http://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+" --include="*.swift" --include="*.rs" --include="*.mm" 2>/dev/null; then
            echo "‚ùå Error: Found hardcoded IP addresses"
            exit 1
          fi
          
          # Check for base64 encoded blobs (potential obfuscated malware)
          if grep -rE "[A-Za-z0-9+/]{100,}={0,2}" --include="*.swift" --include="*.rs" CodeTunner/ backend/src/ 2>/dev/null | grep -v "test\|spec\|mock"; then
            echo "‚ö†Ô∏è Warning: Found long base64-like strings"
          fi
          
          echo "‚úÖ Security scan complete"
          
      - name: Report status
        if: failure()
        run: |
          echo "üö® SECURITY CHECK FAILED"
          echo "Please review the changes carefully before merging."
